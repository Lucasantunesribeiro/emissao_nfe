# ⚠️ SECURITY WARNING - DESENVOLVIMENTO LOCAL APENAS ⚠️
# Este arquivo contém credenciais em texto plano (admin123) e é seguro APENAS para desenvolvimento local.
# NUNCA use essas credenciais em produção ou commit arquivos .env com dados sensíveis.
#
# Para produção na AWS:
# - Use AWS Secrets Manager (já configurado no CDK em infra/cdk/lib/stacks/secrets-stack.ts)
# - As credenciais são geradas automaticamente e rotacionadas pelo CDK
# - Os Lambdas leem credenciais via IAM role (sem expor senhas)
#
# Para rodar localmente com segurança:
# 1. Copie .env.example para .env
# 2. Use senhas fortes geradas aleatoriamente
# 3. Adicione .env no .gitignore (já configurado)

services:
  postgres-estoque:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_ESTOQUE_DB:-estoque}
      POSTGRES_USER: ${POSTGRES_ESTOQUE_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_ESTOQUE_PASSWORD:-admin123}  # ⚠️ APENAS DESENVOLVIMENTO - Use .env para override
    ports:
      - "${POSTGRES_ESTOQUE_PORT:-5432}:5432"
    volumes:
      - estoque-data:/var/lib/postgresql/data
      - ./scripts/migrations/estoque-init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "admin", "-d", "estoque"]
      interval: 5s
      timeout: 3s
      retries: 5

  postgres-faturamento:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_FATURAMENTO_DB:-faturamento}
      POSTGRES_USER: ${POSTGRES_FATURAMENTO_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_FATURAMENTO_PASSWORD:-admin123}  # ⚠️ APENAS DESENVOLVIMENTO - Use .env para override
    ports:
      - "${POSTGRES_FATURAMENTO_PORT:-5433}:5432"
    volumes:
      - faturamento-data:/var/lib/postgresql/data
      - ./scripts/migrations/faturamento-init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "admin", "-d", "faturamento"]
      interval: 5s
      timeout: 3s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-admin123}  # ⚠️ APENAS DESENVOLVIMENTO - Use .env para override
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  servico-estoque:
    build: ./servico-estoque
    ports:
      - "${SERVICO_ESTOQUE_PORT:-5001}:8080"
    environment:
      ConnectionStrings__DefaultConnection: Host=postgres-estoque;Database=${POSTGRES_ESTOQUE_DB:-estoque};Username=${POSTGRES_ESTOQUE_USER:-admin};Password=${POSTGRES_ESTOQUE_PASSWORD:-admin123};Search Path=estoque
      DB_SCHEMA: estoque
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Username: ${RABBITMQ_USER:-admin}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-admin123}  # ⚠️ APENAS DESENVOLVIMENTO - Use .env para override
    depends_on:
      postgres-estoque:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  servico-faturamento:
    build: ./servico-faturamento
    ports:
      - "${SERVICO_FATURAMENTO_PORT:-5002}:8080"
    environment:
      DATABASE_URL: postgres://${POSTGRES_FATURAMENTO_USER:-admin}:${POSTGRES_FATURAMENTO_PASSWORD:-admin123}@postgres-faturamento:5432/${POSTGRES_FATURAMENTO_DB:-faturamento}?sslmode=disable
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672/
    depends_on:
      postgres-faturamento:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  web-app:
    build: ./web-app
    ports:
      - "${WEBAPP_PORT:-4200}:80"
    depends_on:
      - servico-estoque
      - servico-faturamento

volumes:
  estoque-data:
  faturamento-data: